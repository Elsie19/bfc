#!/bin/bash

function array.contains() {
    local check
    local -n arra="${1:?No array passed to array.contains}"
    local input="${2:?No input given to array.contains}"
    for check in "${arra[@]}"; do
        if [[ ${check} == "${input}" ]]; then
            return 0
        fi
    done
    return 1
}

cell_size=30000
while getopts 'o:s:l:' OPTION; do
    case "${OPTION}" in
        o) flags_string="${OPTARG}" custom_flags=true ;;
        s) flags_string="${OPTARG}" custom_flags=false ;;
        l) cell_size="${OPTARG}" ;;
        # Current optimization flags are contract,clear,stack_size
        *) echo "Usage: ${0##*/} [-o optimization,flags] input output" >&2 && exit 1 ;;
    esac
done
shift $((OPTIND - 1))
if [[ -n $flags_string && $custom_flags == true ]]; then
    IFS=',' read -ra flags <<< "${flags_string}"
elif [[ $custom_flags == false ]]; then
    case "${flags_string}" in
        'size' | 's') flags=(contract clear remove_state) flags_string="contract,clear,remove_state" ;;
        'speed' | 3) flags=(contract clear stack_size remove_state) flags_string="contract,clear,stack_size,remove_state" ;;
        *) unset flags_string ;;
    esac
fi

file="${1?No file passed}"
if ! [[ -f ${file} ]]; then
    echo "${0##*/}: ${file} No such file or directory" >&2
fi
out_file="${2?No output file passed}"

echo -e "Building [\033[32m${1##*/}\033[0m]:"
echo -e "  Optimization flags: \033[33m${flags_string-None}\033[0m"
echo -e "  Cell limit: \033[33m${cell_size}\033[0m"

{
    echo "#!/bin/bash"
    echo "# Generated by '${0##*/}' on $(date)"
    echo -e "# Optimization flags: ${flags_string-None}\n"
    echo 'LC_ALL=C'
    echo "cells=({0..${cell_size}})"
    echo 'for i in "${cells[@]}"; do'
    echo 'cells[i]=0'
    echo 'done'
    echo 'declare -i ptr=0'
} > "${out_file}"

# IR representation
bir="$(while IFS= read -r -n1 char; do
    case "${char}" in
        '>') echo 'Add' ;;
        '<') echo 'Sub' ;;
        '+') echo 'Right' ;;
        '-') echo 'Left' ;;
        '.') echo 'Out' ;;
        ',') echo 'In' ;;
        '[') echo 'Open' ;;
        ']') echo 'Close' ;;
        '#') array.contains flags "remove_state" || echo 'State' ;;
        *) : ;; # They're comments
    esac
done < "${file}")"

if array.contains flags "clear"; then
    bir="${bir//Open$'\n'Right$'\n'Close/Clear}"
    bir="${bir//Open$'\n'Left$'\n'Close/Clear}"
fi

# Apply optimizations. We're gonna use uniq to get the count of contiguous duplicate lines hehe.
# Finally! A use for uniq!
prog_ir=()
mapfile -t prog_ir < <(uniq -c <<< "${bir}" | awk '{print $2,$1}')

for line in "${prog_ir[@]}"; do
    case "${line}" in
        'Add'*)
            if array.contains flags "contract"; then
                echo "((ptr+=${line##* }))"
                echo '((ptr > ${#cells[@]})) && ptr=$((ptr - ${#cells[@]}))'
            else
                for ((i = 1; i <= "${line##* }"; i++)); do
                    echo '((ptr++))'
                    echo '((ptr > ${#cells[@]})) && ptr=$((ptr - ${#cells[@]}))'
                done
            fi
            ;;
        'Sub'*)
            if array.contains flags "contract"; then
                echo "((ptr-=${line##* }))"
                echo '((ptr < 0)) && ptr=$((${#cells[@]} + ptr))'
            else
                for ((i = 1; i <= "${line##* }"; i++)); do
                    echo '((ptr--))'
                    echo '((ptr < 0)) && ptr="${#cells[@]}"'
                done
            fi
            ;;
        'Right'*)
            if array.contains flags "contract"; then
                echo "((cells[ptr]+=${line##* }))"
                echo '((cells[ptr] > 255)) && cells[ptr]=$((cells[ptr] - 255))'
            else
                for ((i = 1; i <= "${line##* }"; i++)); do
                    echo '((cells[ptr]++))'
                    echo '((cells[ptr] > 255)) && cells[ptr]=0'
                done
            fi
            ;;
        'Left'*)
            if array.contains flags "contract"; then
                echo "((cells[ptr]-=${line##* }))"
                echo '((cells[ptr] < 0)) && cells[ptr]=$((255 + cells[ptr]))'
            else
                for ((i = 1; i <= "${line##* }"; i++)); do
                    echo '((cells[ptr]--))'
                    echo '((cells[ptr] < 0)) && cells[ptr]=255'
                done
            fi
            ;;
        'Out'*)
            for ((i = 1; i <= "${line##* }"; i++)); do
                echo 'printf -v hex "%x" "${cells[$ptr]}"'
                echo 'printf %b "\x$hex"'
            done
            ;;
        'In'*) for ((i = 1; i <= "${line##* }"; i++)); do
            echo "IFS=$'\n' read -r -n1 input && input+=$'\n'"
            echo '[[ -n $input ]] && {'
            echo "  LC_CTYPE=C printf -v 'cells[ptr]' %d \"'\${input::1}\""
            echo '  input=${input:1}'
            echo '}'
        done ;;
        'Open'*) for ((i = 1; i <= "${line##* }"; i++)); do
            echo 'while ((cells[ptr] != 0)); do'
        done ;;
        'Close'*) for ((i = 1; i <= "${line##* }"; i++)); do
            echo 'done'
        done ;;
        'Clear'*) for ((i = 1; i <= "${line##* }"; i++)); do
            echo 'cells[ptr]=0'
        done ;;
        'State'*) for ((i = 1; i <= "${line##* }"; i++)); do
            echo '# DEBUGGING START'
            echo 'echo -n "["'
            echo "for ((i = 0; i <= 10; i++)); do"
            echo '  if ((i == ptr)); then'
            echo '      printf " \e[31m0x%X\e[0m " "${cells[i]}"'
            echo '  else'
            echo '      printf " 0x%X " "${cells[i]}"'
            echo '  fi'
            echo "done"
            echo "echo ']'"
            echo '# DEBUGGING END'
        done ;;
        *) : ;; # They're comments
    esac
done >> "${out_file}"
chmod +x "${out_file}"
