#!/bin/bash

file="${1?No file passed}"
if ! [[ -f ${file} ]]; then
    echo "${0##*/}: ${file} No such file or directory" >&2
fi
out_file="${2?No output file passed}"

{
    echo "# Generated by '${0##*/}' on $(date)"
    echo -e "# Optimization flags: ${flags-None}\n"
    echo 'cells=({0..30000})'
    echo 'for i in "${cells[@]}"; do'
    echo 'cells[i]=0'
    echo 'done'
    echo 'declare -i ptr=0'
} > "${out_file}"

while IFS= read -r -n1 char; do
    case "${char}" in
        '>') echo '((++ptr))' ;;
        '<') echo '((--ptr))' ;;
        '+') echo '((++cells[ptr]))' && echo '((cells[ptr] > 255)) && cells[ptr]=0' ;;
        '-') echo '((--cells[ptr]))' && echo '((cells[ptr] < 0)) && cells[ptr]=255' ;;
        '.') { echo 'printf -v hex "%x" "${cells[$ptr]}"'
               echo 'printf %b "\x$hex"'
               echo 'unset hex'
           } ;;
        ',') { echo 'read -n1 input'
               echo 'if [[ -n $input ]]; then'
               echo '  cells[ptr]=${input}'
               echo 'fi'
           } ;;
       '[') echo 'while ((cells[ptr])); do' ;;
       ']') echo 'done' ;;
       *) : ;; # They're comments
    esac
done < "${file}" >> "${out_file}"
